<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Monitor - Control Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 40px;
            background: linear-gradient(90deg, #e94560, #0f3460);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #888;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }

        .nav-item.active {
            border-left: 3px solid #e94560;
        }

        .main-content {
            margin-left: 250px;
            padding: 30px;
            min-height: 100vh;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 600;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .status-dot.stopped {
            background: #888;
            animation: none;
        }

        .status-dot.error {
            background: #f87171;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.9);
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #e94560;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-primary {
            background: linear-gradient(135deg, #e94560, #0f3460);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(233, 69, 96, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .btn-danger:hover {
            background: rgba(248, 113, 113, 0.3);
        }

        .btn-success {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .btn-success:hover {
            background: rgba(74, 222, 128, 0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #e0e0e0;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #e94560;
            box-shadow: 0 0 0 3px rgba(233, 69, 96, 0.2);
        }

        .form-input::placeholder {
            color: #555;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .targets-table {
            width: 100%;
            border-collapse: collapse;
        }

        .targets-table th,
        .targets-table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .targets-table th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 600;
            white-space: nowrap;
            /* Prevent wrapping of headers */
        }

        /* Fix mismatch in User View table */
        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .table th {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #888;
            font-weight: 600;
            white-space: nowrap;
        }

        /* Enforce minimum width specifically for Target column to prevent crowding */
        .table td:first-child,
        .targets-table td:first-child {
            min-width: 200px;
        }

        /* Ensure other columns have enough width */
        .targets-table td,
        .table td {
            min-width: 80px;
        }

        .target-name {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .target-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #e94560, #0f3460);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-error {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .badge-idle {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .activity-feed {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 12px 16px;
            border-left: 3px solid #e94560;
            background: rgba(255, 255, 255, 0.02);
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .activity-time {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .activity-message {
            font-size: 13px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 26px;
            transition: 0.3s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }

        .toggle-switch input:checked+.toggle-slider {
            background: #e94560;
        }

        .toggle-switch input:checked+.toggle-slider:before {
            transform: translateX(24px);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .setting-info h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .setting-info p {
            font-size: 12px;
            color: #666;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: #1a1a2e;
            border-radius: 16px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #888;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #e0e0e0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .toast.show {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast.success {
            border-left: 4px solid #4ade80;
        }

        .toast.error {
            border-left: 4px solid #f87171;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .target-actions {
            display: flex;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Sorting styles */
        .sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable:hover {
            color: #e94560 !important;
        }

        .sort-indicator {
            display: inline-block;
            margin-left: 5px;
            font-size: 10px;
            vertical-align: middle;
            opacity: 0.5;
            transition: transform 0.2s, opacity 0.2s;
        }

        .sort-indicator.active {
            opacity: 1;
            color: #e94560;
        }

        .sort-indicator.desc {
            transform: rotate(180deg);
        }
    </style>
</head>

<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="logo">üì∏ Instagram Monitor</div>

        <div class="nav-item active" data-page="dashboard" onclick="showPage('dashboard')">
            <span>üìä</span> Dashboard
        </div>
        <div class="nav-item" data-page="targets" onclick="showPage('targets')">
            <span>üë•</span> Targets
        </div>
        <div class="nav-item" data-page="session" onclick="showPage('session')">
            <span>üîê</span> Session
        </div>
        <div class="nav-item" data-page="settings" onclick="showPage('settings')">
            <span>‚öôÔ∏è</span> Settings
        </div>
        <div class="nav-item" data-page="activity" onclick="showPage('activity')">
            <span>üìú</span> Activity Log
        </div>

        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="font-size: 12px; color: #666;">
                <div>Uptime: <span id="server-uptime">-</span></div>
                <div style="margin-top: 4px;" id="tool-version">v{{ version }}</div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard Page -->
        <div id="page-dashboard" class="page active">
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div
                        style="display: flex; gap: 8px; background: rgba(255,255,255,0.05); padding: 4px; border-radius: 8px;">
                        <button id="mode-user-btn" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;"
                            onclick="setUIMode('user')" title="User Mode - Simple view">
                            üë§ User
                        </button>
                        <button id="mode-config-btn" class="btn btn-secondary"
                            style="padding: 8px 16px; font-size: 13px;" onclick="setUIMode('config')"
                            title="Config Mode - Detailed view">
                            ‚öôÔ∏è Config
                        </button>
                    </div>
                    <div class="status-indicator">
                        <div class="status-dot" id="global-status-dot"></div>
                        <span id="global-status-text">Idle</span>
                    </div>
                </div>
            </div>

            <div class="quick-actions">
                <button class="btn btn-primary" onclick="showModal('add-target')">
                    <span>‚ûï</span> Add Target
                </button>
                <button class="btn btn-success" id="start-all-btn" onclick="startAllMonitoring()">
                    <span>‚ñ∂Ô∏è</span> Start All
                </button>
                <button class="btn btn-info" id="recheck-all-btn" onclick="triggerCheck()">
                    <span>üîÑ</span> Recheck All
                </button>
                <button class="btn btn-danger" id="stop-all-btn" onclick="stopAllMonitoring()">
                    <span>‚èπÔ∏è</span> Stop All
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Active Targets</div>
                    <div class="stat-value" id="active-targets">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Checks</div>
                    <div class="stat-value" id="total-checks">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Last Check</div>
                    <div class="stat-value" id="last-check" style="font-size: 16px;">-</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Next Check</div>
                    <div class="stat-value" id="next-check" style="font-size: 16px;">-</div>
                </div>
            </div>

            <!-- User mode: Simple view -->
            <div id="dashboard-user-mode" class="dashboard-mode">
                <div class="card">
                    <div class="card-title">Monitored Targets</div>
                    <table class="table">
                        <thead>
                            <tr>
                            <tr>
                                <th class="sortable" onclick="toggleTargetSort()">
                                    Target <span id="sort-indicator-user" class="sort-indicator">‚ñ≤</span>
                                </th>
                                <th>Vis.</th>
                                <th>Followers</th>
                                <th>Following</th>
                                <th>Posts</th>
                                <th>Reels</th>
                                <th>Story</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-targets-simple-body">
                            <tr>
                                <td colspan="6">
                                    <div class="empty-state">
                                        <div class="empty-state-icon">üë•</div>
                                        <p>Loading targets...</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Last Fetched Card -->
                <div class="card" style="margin-top: 24px;">
                    <div class="card-title">Last Fetched Update</div>
                    <div id="last-fetched-container">
                        <!-- Populated by JS -->
                        <div class="empty-state">
                            <p>No recent updates found.</p>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-title">Recent Activity</div>
                    <div class="activity-feed" id="dashboard-activity">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìú</div>
                            <p>No activity yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unified Config Page -->
            <div id="dashboard-config-mode" class="dashboard-mode" style="display: none;">
                <div class="card">
                    <div class="card-title">Detailed Configuration</div>
                    <div class="settings-grid" id="full-config-grid"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-title">Environment Details</div>
                    <div class="settings-grid" id="env-details-grid"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-title">Detailed Targets View</div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="toggleTargetSort()">
                                    Target <span id="sort-indicator-config" class="sort-indicator">‚ñ≤</span>
                                </th>
                                <th>Vis.</th>
                                <th>Followers</th>
                                <th>Following</th>
                                <th>Posts</th>
                                <th>Reels</th>
                                <th>Story</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-targets-body">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="card" style="margin-top: 24px;">
                    <div class="card-title">Recent Activity</div>
                    <div class="activity-feed" id="dashboard-activity-config">
                        <!-- Mirror of activity feed -->
                        <div class="empty-state">
                            <div class="empty-state-icon">üìú</div>
                            <p>No activity yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Targets Page -->
        <div id="page-targets" class="page">
            <div class="page-header">
                <h1 class="page-title">Manage Targets</h1>
                <button class="btn btn-primary" onclick="showModal('add-target')">
                    <span>‚ûï</span> Add Target
                </button>
            </div>

            <div class="card">
                <table class="targets-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="toggleTargetSort()">
                                Username <span id="sort-indicator-targets" class="sort-indicator">‚ñ≤</span>
                            </th>
                            <th>Added</th>
                            <th>Status</th>
                            <th>Last Checked</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="targets-list">
                        <tr>
                            <td colspan="5">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üì≠</div>
                                    <p>No targets configured</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Session Page -->
        <div id="page-session" class="page">
            <div class="page-header">
                <h1 class="page-title">Session Management</h1>
            </div>

            <div class="card">
                <div class="card-title">Instagram Session</div>
                <p style="color: #888; margin-bottom: 20px;">
                    A logged-in session is required to fetch followers, followings, stories, and detailed post info.
                </p>

                <div class="setting-row">
                    <div class="setting-info">
                        <h4>Session Status</h4>
                        <p id="session-status-text">Not configured</p>
                    </div>
                    <span class="badge badge-idle" id="session-badge">Inactive</span>
                </div>

                <div class="form-group" style="margin-top: 24px;">
                    <label class="form-label">Instagram Username (for session)</label>
                    <input type="text" class="form-input" id="session-username" placeholder="your_instagram_username">
                </div>

                <div class="form-group">
                    <label class="form-label">Session Method</label>
                    <select class="form-input" id="session-method">
                        <option value="firefox">Import from Firefox (Recommended)</option>
                        <option value="saved">Use Saved Session</option>
                    </select>
                </div>

                <div style="margin-top: 24px; display: flex; gap: 12px;">
                    <button class="btn btn-primary" onclick="configureSession()">
                        <span>üîê</span> Configure Session
                    </button>
                    <button class="btn btn-secondary" onclick="testSession()">
                        <span>üß™</span> Test Session
                    </button>
                </div>

                <p style="color: #666; font-size: 12px; margin-top: 16px;">
                    üí° Tip: For Firefox session import, first log into Instagram in Firefox, then run:<br>
                    <code
                        style="background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; margin-top: 8px; display: inline-block;">
                        instagram_monitor --import-firefox-session -u YOUR_USERNAME
                    </code>
                </p>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="page-settings" class="page">
            <div class="page-header">
                <h1 class="page-title">Settings</h1>
                <button class="btn btn-primary" onclick="saveSettings()">
                    <span>üíæ</span> Save Settings
                </button>
            </div>

            <div class="card">
                <div class="card-title">Check Intervals</div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Check Interval (seconds)</label>
                        <input type="number" class="form-input" id="check-interval" value="5400" min="300">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Random Variation Low (seconds)</label>
                        <input type="number" class="form-input" id="random-low" value="900" min="0">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Random Variation High (seconds)</label>
                    <input type="number" class="form-input" id="random-high" value="180" min="0">
                </div>
            </div>

            <div class="card">
                <div class="card-title">Notifications</div>

                <div class="setting-row">
                    <div class="setting-info">
                        <h4>Email Notifications</h4>
                        <p>Send email on status changes</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="email-notifications">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <h4>Follower Notifications</h4>
                        <p>Send email on follower changes</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="follower-notifications">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <h4>Webhook Enabled</h4>
                        <p>Send Discord/webhook notifications</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="webhook-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group" style="margin-top: 16px;">
                    <label class="form-label">Webhook URL</label>
                    <input type="text" class="form-input" id="webhook-url"
                        placeholder="https://discord.com/api/webhooks/...">
                </div>
            </div>

            <div class="card">
                <div class="card-title">Advanced</div>

                <div class="setting-row">
                    <div class="setting-info">
                        <h4>Detailed Follower Logging</h4>
                        <p>Fetch full follower list every check</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="detailed-logging">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="setting-row">
                    <div class="setting-info">
                        <h4>Debug Mode</h4>
                        <p>Show verbose output in console</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="debug-mode">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Activity Page -->
        <div id="page-activity" class="page">
            <div class="page-header">
                <h1 class="page-title">Activity Log</h1>
                <button class="btn btn-secondary" onclick="clearActivity()">
                    <span>üóëÔ∏è</span> Clear Log
                </button>
            </div>

            <div class="card">
                <div class="activity-feed" id="activity-feed">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <p>No activity yet</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Target Modal -->
    <div class="modal-overlay" id="modal-add-target">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Add Target</h2>
                <button class="modal-close" onclick="hideModal('add-target')">&times;</button>
            </div>

            <div class="form-group">
                <label class="form-label">Instagram Username</label>
                <input type="text" class="form-input" id="new-target-username" placeholder="username"
                    onkeypress="if(event.key==='Enter')addTarget()">
            </div>

            <div class="setting-row" style="border: none; padding-bottom: 0;">
                <div class="setting-info">
                    <h4>Start monitoring immediately</h4>
                    <p>Begin monitoring after adding</p>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="start-immediately" checked>
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div style="margin-top: 24px; display: flex; gap: 12px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="hideModal('add-target')">Cancel</button>
                <button class="btn btn-primary" onclick="addTarget()">
                    <span>‚ûï</span> Add Target
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toast-message"></span>
    </div>

    <!-- Critical Error Modal -->
    <div class="modal-overlay" id="error-modal" style="z-index: 9999; background: rgba(0,0,0,0.9);">
        <div class="modal" style="border: 1px solid #dc3545; box-shadow: 0 4px 25px rgba(220, 53, 69, 0.5);">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545, #a71d2a); color: white;">
                <h2 class="modal-title">‚ö†Ô∏è Critical Error</h2>
            </div>
            <div class="modal-body">
                <p style="color: #ff6b6b; font-weight: bold; margin-bottom: 16px; font-size: 16px;">
                    The monitoring process has encountered a critical error.
                </p>
                <div id="error-traceback" style="
                    background: #111;
                    padding: 16px;
                    border-radius: 8px;
                    overflow: auto;
                    font-family: 'JetBrains Mono', 'Fira Code', monospace;
                    font-size: 12px;
                    color: #ff8787;
                    border: 1px solid #444;
                    max-height: 400px;
                    white-space: pre-wrap;
                    line-height: 1.4;">Waiting for error details...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="location.reload()">Reload Page</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let targets = {};
        let activities = [];
        let settings = {};
        let isMonitoring = false;
        let currentUIMode = 'user'; // Default to user mode

        // UI Mode handling
        async function setUIMode(mode) {
            if (mode !== 'user' && mode !== 'config') return;

            try {
                const response = await fetch('/api/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const data = await response.json();
                if (data.success) {
                    currentUIMode = mode;
                    updateUIModeDisplay();
                    showToast(`Switched to ${mode} mode`);
                }
            } catch (err) {
                console.error('Failed to set UI mode:', err);
                showToast('Failed to switch mode', 'error');
            }
        }

        function updateUIModeDisplay() {
            // Update button states
            const userBtn = document.getElementById('mode-user-btn');
            const configBtn = document.getElementById('mode-config-btn');

            if (currentUIMode === 'user') {
                userBtn.classList.add('btn-primary');
                userBtn.classList.remove('btn-secondary');
                configBtn.classList.remove('btn-primary');
                configBtn.classList.add('btn-secondary');
                document.getElementById('dashboard-user-mode').style.display = 'block';
                document.getElementById('dashboard-config-mode').style.display = 'none';
            } else {
                configBtn.classList.add('btn-primary');
                configBtn.classList.remove('btn-secondary');
                userBtn.classList.remove('btn-primary');
                userBtn.classList.add('btn-secondary');
                document.getElementById('dashboard-user-mode').style.display = 'none';
                document.getElementById('dashboard-config-mode').style.display = 'block';
            }
        }

        // Navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            document.getElementById(`page-${pageName}`).classList.add('active');
            document.querySelector(`[data-page="${pageName}"]`).classList.add('active');
        }

        // Modal
        function showModal(modalId) {
            document.getElementById(`modal-${modalId}`).classList.add('active');
            // Focus on input
            setTimeout(() => {
                const input = document.getElementById('new-target-username');
                if (input) input.focus();
            }, 100);
        }

        function hideModal(modalId) {
            document.getElementById(`modal-${modalId}`).classList.remove('active');
        }

        // Close modal when clicking overlay (but not modal content)
        document.getElementById('modal-add-target').addEventListener('click', function (e) {
            if (e.target.id === 'modal-add-target') {
                hideModal('add-target');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const activeModal = document.querySelector('.modal-overlay.active');
                if (activeModal) {
                    const modalId = activeModal.id.replace('modal-', '');
                    hideModal(modalId);
                }
            }
        });

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `toast show ${type}`;
            document.getElementById('toast-message').textContent = message;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // API calls
        async function fetchStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                updateDashboard(data);
            } catch (err) {
                console.error('Failed to fetch status:', err);
                showToast('Failed to fetch status', 'error');
            }
        }

        async function fetchSettings() {
            try {
                const response = await fetch('/api/settings');
                settings = await response.json();
                populateSettings(settings);
            } catch (err) {
                console.error('Failed to fetch settings:', err);
            }
        }

        let currentTargetSort = 'asc'; // 'asc', 'desc'
        let dashboardData = null; // Store full data

        function toggleTargetSort() {
            if (currentTargetSort === 'asc') currentTargetSort = 'desc';
            else currentTargetSort = 'asc';

            updateSortIndicators();
            if (dashboardData) {
                renderTargetsTable(dashboardData.last_check, dashboardData.next_check);
            }
        }

        function updateSortIndicators() {
            const indicators = [
                document.getElementById('sort-indicator-user'),
                document.getElementById('sort-indicator-config'),
                document.getElementById('sort-indicator-targets')
            ];

            indicators.forEach(ind => {
                if (!ind) return;
                ind.classList.remove('desc');
                ind.style.opacity = '1';
                ind.classList.add('active');
                if (currentTargetSort === 'desc') {
                    ind.classList.add('desc');
                }
            });
        }

        function getSortedTargets() {
            const entries = Object.entries(targets);

            return entries.sort((a, b) => {
                const nameA = a[0].toLowerCase();
                const nameB = b[0].toLowerCase();
                if (currentTargetSort === 'asc') {
                    return nameA.localeCompare(nameB);
                } else {
                    return nameB.localeCompare(nameA);
                }
            });
        }

        function updateDashboard(data) {
            dashboardData = data;
            // Check for critical error FIRST
            if (data.error) {
                const modal = document.getElementById('error-modal');
                const trace = document.getElementById('error-traceback');

                // Format timestamp
                const date = new Date(data.error.timestamp * 1000).toLocaleString();

                trace.innerHTML = `<strong>Error:</strong> ${escapeHtml(data.error.message)}<br><br>` +
                    `<strong>Time:</strong> ${date}<br><br>` +
                    `<strong>Traceback:</strong><br>${escapeHtml(data.error.traceback).replace(/\n/g, '<br>')}`;

                modal.classList.add('active'); // Use existing modal activation
                // Disable background interaction? No strict need, overlay covers it.
                return; // Stop updating dashboard
            }

            // Update UI mode if changed
            if (data.ui_mode && data.ui_mode !== currentUIMode) {
                currentUIMode = data.ui_mode;
                updateUIModeDisplay();
            }

            // Update stats
            const targetCount = Object.keys(data.targets || {}).length;
            const monitoringCount = Object.values(data.targets || {}).filter(t =>
                t.status && t.status.toLowerCase() !== 'idle' && t.status.toLowerCase() !== 'stopped'
            ).length;

            document.getElementById('active-targets').textContent = targetCount;
            document.getElementById('total-checks').textContent = data.check_count || 0;
            document.getElementById('last-check').textContent = data.last_check || '-';
            document.getElementById('next-check').textContent = data.next_check || '-';
            document.getElementById('server-uptime').textContent = data.uptime || '-';

            // Update status
            const statusDot = document.getElementById('global-status-dot');
            const statusText = document.getElementById('global-status-text');

            if (data.is_monitoring || monitoringCount > 0) {
                statusDot.className = 'status-dot';
                statusText.textContent = `Monitoring (${monitoringCount})`;
                isMonitoring = true;
            } else {
                statusDot.className = 'status-dot stopped';
                statusText.textContent = 'Idle';
                isMonitoring = false;
            }

            // Update targets table
            targets = data.targets || {};
            renderTargetsTable(data.last_check, data.next_check);

            // Render Last Fetched Card
            renderLastFetched();

            // Render Full Config Grid
            if (data.config) {
                renderFullConfig(data.config);
            }

            // Update session info
            if (data.session) {
                document.getElementById('session-status-text').textContent =
                    data.session.username ? `Configured for: ${escapeHtml(data.session.username)}` : 'Not configured';
                document.getElementById('session-badge').className =
                    `badge ${data.session.active ? 'badge-success' : 'badge-idle'}`;
                document.getElementById('session-badge').textContent =
                    data.session.active ? 'Active' : 'Inactive';
                if (data.session.username) {
                    document.getElementById('session-username').value = data.session.username;
                }
            }

            // Update activities
            if (data.activities) {
                activities = data.activities;
                renderActivities();
                renderDashboardActivities();
            }
        }

        function renderLastFetched() {
            const container = document.getElementById('last-fetched-container');
            let latestUpdate = null;

            // Find latest update across targets
            for (const tData of Object.values(targets)) {
                if (tData.last_post) {
                    latestUpdate = tData.last_post;
                    break; // Simple logic: take first one found
                }
                if (tData.last_story) {
                    latestUpdate = tData.last_story;
                    break;
                }
            }

            if (!latestUpdate) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No recent updates found.</p>
                    </div>
                 `;
                return;
            }

            const caption = latestUpdate.caption ? escapeHtml(latestUpdate.caption) : '';
            const isImage = latestUpdate.url && (latestUpdate.url.includes('.jpg') || latestUpdate.url.includes('.jpeg') || latestUpdate.url.includes('.png'));

            container.innerHTML = `
                <div style="display: flex; gap: 16px; align-items: flex-start;">
                    ${isImage ? `<img src="${latestUpdate.url}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #333;">` : ''}
                    <div>
                        <div style="font-weight: bold; color: #00bcd4; margin-bottom: 4px;">${escapeHtml(latestUpdate.type || 'Unknown')}</div>
                        <div style="font-size: 12px; color: #888; margin-bottom: 8px;">${escapeHtml(latestUpdate.timestamp || '-')}</div>
                        <div style="font-size: 14px; margin-bottom: 4px;">${caption}</div>
                        ${latestUpdate.url ? `<a href="${latestUpdate.url}" target="_blank" style="font-size: 12px; text-decoration: underline;">View Media</a>` : ''}
                    </div>
                </div>
             `;
        }

        function renderFullConfig(config) {
            const grid = document.getElementById('full-config-grid');
            if (!grid) return;

            // Main configuration items
            const items = [
                { l: 'Session User', v: config.session_user },
                { l: 'Polling Interval', v: config.check_interval_str },
                { l: 'Hours Range', v: config.hours_range },
                { l: 'Email Status', v: config.email_notifications ? 'Enabled' : 'Disabled' },
                { l: 'Email Followers', v: config.follower_notifications ? 'Enabled' : 'Disabled' },
                { l: 'Email Errors', v: config.error_notifications ? 'Enabled' : 'Disabled' },
                { l: 'Session Mode', v: config.session_mode },
                { l: 'Skip Session', v: config.skip_session_login },
                { l: 'Skip Followers', v: config.skip_followers },
                { l: 'Skip Followings', v: config.skip_followings },
                { l: 'Skip Stories Details', v: config.skip_stories },
                { l: 'Skip Posts Details', v: config.skip_posts },
                { l: 'Get More Posts Details', v: config.get_more_post_details },
                { l: 'Detailed Follower Logging', v: config.detailed_logging },
                { l: 'Jitter/Back-off', v: config.enable_jitter },
                { l: 'Liveness', v: config.liveness_check },
                { l: 'Profile Pic Detect', v: config.profile_pic_changes },
                { l: 'Display Profile Pics', v: config.imgcat },
                { l: 'Empty Pic Template', v: config.empty_profile_pic },
                { l: 'Dashboard', v: config.dashboard_status },
                { l: 'Web Dashboard', v: config.web_dashboard_status },
                { l: 'CSV Logging', v: config.csv_logging },
                { l: 'Output Logging', v: config.logging_enabled },
                { l: 'Output Dir', v: (config.output_dir === '.' || !config.output_dir) ? '-' : config.output_dir },
                { l: 'Templates', v: config.template_dir },
                { l: 'Webhook', v: config.webhook_enabled },
                { l: 'Debug Mode', v: config.debug_mode },
            ];

            // Environment specific items
            const envItems = [
                { l: 'Browser User Agent', v: config.user_agent ? config.user_agent : '-' },
                { l: 'Mobile User Agent', v: config.user_agent_mobile ? config.user_agent_mobile : '-' },
                { l: 'Local Timezone', v: config.local_timezone },
                { l: 'Config File', v: config.config_file },
                { l: 'Dotenv File', v: config.dotenv_file },
            ];

            const renderItems = (itemList, targetGrid) => {
                targetGrid.innerHTML = itemList.map(item => `
                    <div class="setting-row" style="border: none; padding: 0;">
                        <div class="setting-info">
                            <h4 style="font-size: 12px; color: #888; text-transform: uppercase;">${escapeHtml(item.l)}</h4>
                            <p style="font-size: 14px; color: #ddd; word-break: break-all;">${(() => {
                        let val = item.v !== undefined && item.v !== null ? String(item.v) : '-';
                        if (val === 'true') return 'True';
                        if (val === 'false') return 'False';
                        return escapeHtml(val);
                    })()}</p>
                        </div>
                    </div>
                `).join('');
            };

            renderItems(items, grid);

            const envGrid = document.getElementById('env-details-grid');
            if (envGrid) {
                renderItems(envItems, envGrid);
            }
        }

        function renderDashboardActivities() {
            const feed = document.getElementById('dashboard-activity');
            const feedConfig = document.getElementById('dashboard-activity-config');
            const recentActivities = activities.slice(0, 10); // last 10 events

            const html = recentActivities.length === 0 ? `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <p>No activity yet</p>
                    </div>
                ` : recentActivities.map(a => `
                <div class="activity-item">
                    <div class="activity-time">${a.time}</div>
                    <div class="activity-message">${a.message}</div>
                </div>
            `).join('');

            if (feed) feed.innerHTML = html;
            if (feedConfig) feedConfig.innerHTML = html;
        }

        function renderTargetsTable(globalLastCheck, globalNextCheck) {
            const tbody = document.getElementById('dashboard-targets-body');
            const tbodySimple = document.getElementById('dashboard-targets-simple-body');
            const targetsList = document.getElementById('targets-list');
            const sortedEntries = getSortedTargets();

            if (Object.keys(targets).length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6">
                            <div class="empty-state">
                                <div class="empty-state-icon">üë•</div>
                                <p>No targets added yet. Click "Add Target" to start monitoring.</p>
                            </div>
                        </td>
                    </tr>
                `;
                if (tbodySimple) {
                    tbodySimple.innerHTML = `
                        <tr>
                            <td colspan="5">
                                <div class="empty-state">
                                    <div class="empty-state-icon">üë•</div>
                                    <p>No targets added yet. Click "Add Target" to start monitoring.</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
                targetsList.innerHTML = `
                    <tr>
                        <td colspan="5">
                            <div class="empty-state">
                                <div class="empty-state-icon">üì≠</div>
                                <p>No targets configured</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            // Render simple view for user mode (Expanded with more columns now)
            if (tbodySimple) {
                const lastCheck = globalLastCheck || '-';
                const nextCheck = globalNextCheck || '-';

                tbodySimple.innerHTML = sortedEntries.map(([name, data]) => `
                    <tr>
                        <td>
                            <div class="target-name">
                                <div class="target-avatar">${name.charAt(0).toUpperCase()}</div>
                                <div>
                                    <div><a href="https://instagram.com/${encodeURIComponent(name)}" target="_blank" style="color: inherit; text-decoration: none;">${escapeHtml(name)}</a></div>
                                    <div style="font-size: 12px; color: #666;">@${escapeHtml(name)}</div>
                                </div>
                            </div>
                        </td>
                        <td>${data.is_private === true ? 'PRI' : (data.is_private === false ? 'PUB' : '-')}</td>
                        <td>${data.followers ?? '-'}</td>
                        <td>${data.following ?? '-'}</td>
                        <td>${data.posts ?? '-'}</td>
                        <td>${data.reels ?? '-'}</td>
                        <td>${data.has_story ? (data.stories_count > 0 ? '‚ú® ' + data.stories_count : '‚ú® Yes') : '-'}</td>
                        <td><span class="badge badge-${getStatusBadge(data.status)}">${data.status || 'Idle'}</span></td>
                    </tr>
                `).join('');
            }

            tbody.innerHTML = sortedEntries.map(([name, data]) => `
                <tr>
                    <td>
                        <div class="target-name">
                            <div class="target-avatar">${name.charAt(0).toUpperCase()}</div>
                            <div>
                                <div><a href="https://instagram.com/${encodeURIComponent(name)}" target="_blank" style="color: inherit; text-decoration: none;">${escapeHtml(name)}</a></div>
                                <div style="font-size: 12px; color: #666;">@${escapeHtml(name)}</div>
                            </div>
                        </div>
                    </td>
                    <td>${data.is_private === true ? 'PRI' : (data.is_private === false ? 'PUB' : '-')}</td>
                    <td>${data.followers ?? '-'}</td>
                    <td>${data.following ?? '-'}</td>
                    <td>${data.posts ?? '-'}</td>
                    <td>${data.reels ?? '-'}</td>
                    <td>${data.has_story ? (data.stories_count > 0 ? '‚ú® ' + data.stories_count : '‚ú® Yes') : '-'}</td>
                    <td><span class="badge badge-${getStatusBadge(data.status)}">${data.status || 'Idle'}</span></td>
                    <td>
                        <div class="target-actions">
                            <button class="btn btn-secondary btn-sm" onclick="triggerCheck('${escapeHtml(name)}')" title="Recheck" aria-label="Recheck for ${escapeHtml(name)}">
                                üîÑ
                            </button>
                            <button class="btn btn-success btn-sm" onclick="startMonitoring('${escapeHtml(name)}')" title="Start" aria-label="Start monitoring ${escapeHtml(name)}">
                                ‚ñ∂Ô∏è
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="stopMonitoring('${escapeHtml(name)}')" title="Stop" aria-label="Stop monitoring ${escapeHtml(name)}">
                                ‚èπÔ∏è
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeTarget('${escapeHtml(name)}')" title="Remove" aria-label="Remove target ${escapeHtml(name)}">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            targetsList.innerHTML = sortedEntries.map(([name, data]) => `
                <tr>
                    <td>
                        <div class="target-name">
                            <div class="target-avatar">${name.charAt(0).toUpperCase()}</div>
                            <span><a href="https://instagram.com/${encodeURIComponent(name)}" target="_blank" style="color: inherit; text-decoration: none;">${escapeHtml(name)}</a></span>
                        </div>
                    </td>
                    <td>${data.added || '-'}</td>
                    <td><span class="badge badge-${getStatusBadge(data.status)}">${data.status || 'Idle'}</span></td>
                    <td>${data.last_checked || 'Never'}</td>
                    <td>
                        <div class="target-actions">
                            <button class="btn btn-secondary btn-sm" onclick="triggerCheck('${escapeHtml(name)}')" title="Recheck" aria-label="Recheck for ${escapeHtml(name)}">
                                üîÑ
                            </button>
                            <button class="btn btn-success btn-sm" onclick="startMonitoring('${escapeHtml(name)}')" title="Start" aria-label="Start monitoring ${escapeHtml(name)}">
                                ‚ñ∂Ô∏è
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="stopMonitoring('${escapeHtml(name)}')" title="Stop" aria-label="Stop monitoring ${escapeHtml(name)}">
                                ‚èπÔ∏è
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="removeTarget('${escapeHtml(name)}')" title="Remove" aria-label="Remove target ${escapeHtml(name)}">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusBadge(status) {
            if (!status) return 'idle';
            status = status.toLowerCase();
            if (status === 'ok' || status === 'monitoring' || status === 'running') return 'success';
            if (status === 'checking' || status === 'starting' || status === 'pending') return 'warning';
            if (status === 'error') return 'error';
            return 'idle';
        }

        function renderActivities() {
            const feed = document.getElementById('activity-feed');
            if (activities.length === 0) {
                feed.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <p>No activity yet</p>
                    </div>
                `;
                return;
            }

            feed.innerHTML = activities.map(a => `
                <div class="activity-item">
                    <div class="activity-time">${a.time}</div>
                    <div class="activity-message">${a.message}</div>
                </div>
            `).join('');
        }



        function populateSettings(s) {
            document.getElementById('check-interval').value = s.check_interval || 5400;
            document.getElementById('random-low').value = s.random_low || 900;
            document.getElementById('random-high').value = s.random_high || 180;
            document.getElementById('email-notifications').checked = s.email_notifications || false;
            document.getElementById('follower-notifications').checked = s.follower_notifications || false;
            document.getElementById('webhook-enabled').checked = s.webhook_enabled || false;
            document.getElementById('webhook-url').value = s.webhook_url || '';
            document.getElementById('detailed-logging').checked = s.detailed_logging || false;
            document.getElementById('debug-mode').checked = s.debug_mode || false;
            if (s.session_username) {
                document.getElementById('session-username').value = s.session_username;
            }
        }

        // Actions
        async function addTarget() {
            const username = document.getElementById('new-target-username').value.trim().toLowerCase();
            const startNow = document.getElementById('start-immediately').checked;

            if (!username) {
                showToast('Please enter a username', 'error');
                return;
            }

            try {
                const response = await fetch('/api/targets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, start: startNow })
                });

                const data = await response.json();
                if (data.success) {
                    showToast(`Added target: ${username}`);
                    hideModal('add-target');
                    document.getElementById('new-target-username').value = '';
                    fetchStatus();
                } else {
                    showToast(data.error || 'Failed to add target', 'error');
                }
            } catch (err) {
                showToast('Failed to add target', 'error');
            }
        }

        async function removeTarget(username) {
            if (!confirm(`Remove ${username} from monitoring?`)) return;

            try {
                const response = await fetch(`/api/targets/${username}`, { method: 'DELETE' });
                const data = await response.json();
                if (data.success) {
                    showToast(`Removed target: ${username}`);
                    fetchStatus();
                } else {
                    showToast(data.error || 'Failed to remove target', 'error');
                }
            } catch (err) {
                showToast('Failed to remove target', 'error');
            }
        }

        async function startMonitoring(username) {
            try {
                const response = await fetch('/api/monitoring/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: username })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`Started monitoring: ${username}`);
                    fetchStatus();
                } else {
                    showToast(data.error || 'Failed to start monitoring', 'error');
                }
            } catch (err) {
                showToast('Failed to start monitoring', 'error');
            }
        }

        async function stopMonitoring(username) {
            try {
                const response = await fetch('/api/monitoring/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: username })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(`Stopped monitoring: ${username}`);
                    fetchStatus();
                } else {
                    showToast(data.error || 'Failed to stop monitoring', 'error');
                }
            } catch (err) {
                showToast('Failed to stop monitoring', 'error');
            }
        }

        async function startAllMonitoring() {
            try {
                const response = await fetch('/api/monitoring/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Started all monitoring');
                    fetchStatus();
                } else {
                    showToast(data.error || 'Failed to start monitoring', 'error');
                }
            } catch (err) {
                showToast('Failed to start monitoring', 'error');
            }
        }

        async function stopAllMonitoring() {
            try {
                const response = await fetch('/api/monitoring/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Stopped all monitoring');
                    fetchStatus();
                } else {
                    showToast(data.error || 'Failed to stop monitoring', 'error');
                }
            } catch (err) {
                showToast('Failed to stop monitoring', 'error');
            }
        }

        async function triggerCheck(username) {
            try {
                const response = await fetch('/api/trigger-check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: username })
                });
                const data = await response.json();
                if (data.success) {
                    if (username) {
                        showToast(`Check triggered for ${username}`);
                    } else {
                        showToast('Recheck all triggered');
                    }
                }
            } catch (err) {
                showToast('Failed to trigger check', 'error');
            }
        }

        async function saveSettings() {
            const newSettings = {
                check_interval: parseInt(document.getElementById('check-interval').value),
                random_low: parseInt(document.getElementById('random-low').value),
                random_high: parseInt(document.getElementById('random-high').value),
                email_notifications: document.getElementById('email-notifications').checked,
                follower_notifications: document.getElementById('follower-notifications').checked,
                webhook_enabled: document.getElementById('webhook-enabled').checked,
                webhook_url: document.getElementById('webhook-url').value,
                detailed_logging: document.getElementById('detailed-logging').checked,
                debug_mode: document.getElementById('debug-mode').checked
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newSettings)
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Settings saved');
                } else {
                    showToast(data.error || 'Failed to save settings', 'error');
                }
            } catch (err) {
                showToast('Failed to save settings', 'error');
            }
        }

        async function configureSession() {
            const username = document.getElementById('session-username').value.trim();
            const method = document.getElementById('session-method').value;

            if (!username) {
                showToast('Please enter a username', 'error');
                return;
            }

            try {
                const response = await fetch('/api/session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, method })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Session configured');
                    fetchStatus();
                } else {
                    showToast(data.error || 'Failed to configure session', 'error');
                }
            } catch (err) {
                showToast('Failed to configure session', 'error');
            }
        }

        async function testSession() {
            try {
                showToast('Testing session...');
                const response = await fetch('/api/session/test', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast(`Session valid: ${escapeHtml(data.username)}`);
                    fetchStatus();
                } else {
                    showToast(data.error || 'Session test failed', 'error');
                }
            } catch (err) {
                showToast('Session test failed', 'error');
            }
        }

        async function clearActivity() {
            activities = [];
            renderActivities();
            renderDashboardActivities();
            await fetch('/api/activity/clear', { method: 'POST' });
            showToast('Activity log cleared');
        }

        // HTML escaping function to prevent XSS
        function escapeHtml(text) {
            if (text == null) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }

        // Initial load and polling
        (async () => {
            await fetchStatus();
            updateUIModeDisplay();
        })();
        fetchSettings();
        setInterval(fetchStatus, 5000);
    </script>
</body>

</html>
